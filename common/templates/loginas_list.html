{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="container mt-4">
  <h2 class="mb-3">Login As Another User</h2>

  {% if not user.is_superuser %}
    <div class="alert alert-danger">You are not authorized to use this feature.</div>
  {% else %}
    <div class="mb-3">
      <input type="search" class="form-control" id="loginAsSearchInput" placeholder="Search users by name or username...">
    </div>

    <div id="loginAsResults" class="list-group">
      <!-- Results will be inserted here -->
    </div>

    <div class="d-flex justify-content-center mt-3">
      <button id="loadMoreBtn" class="btn btn-outline-primary d-none">Load More</button>
    </div>
  {% endif %}
</div>

<script>
let page = 1;

function renderUser(user) {
  return `
    <a href="{% url 'api-login-as' %}?user_pk=${user.id}&next=${encodeURIComponent(window.location.pathname)}" 
       class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
      <div>
        <strong>${user.first_name} ${user.last_name}</strong> 
        <small class="text-muted">(${user.username})</small><br>
        <span class="text-muted small">${user.alias || ''} - ${user.job_title || ''}</span>
      </div>
      <i class="bi bi-box-arrow-in-right"></i>
    </a>
  `;
}

function loadUsers(reset = false) {
  const query = document.getElementById("loginAsSearchInput").value;
  const resultsEl = document.getElementById("loginAsResults");
  const loadMoreBtn = document.getElementById("loadMoreBtn");

  if (reset) {
    page = 1;
    resultsEl.innerHTML = "";
  }

  fetch("{% url 'user_search' %}?q=" + encodeURIComponent(query) + "&page=" + page)
    .then(r => r.json())
    .then(data => {
      data.users.forEach(u => {
        resultsEl.insertAdjacentHTML('beforeend', renderUser(u));
      });

      if (data.has_more) {
        page += 1;
        loadMoreBtn.classList.remove('d-none');
      } else {
        loadMoreBtn.classList.add('d-none');
      }
    })
    .catch(err => {
      console.error("Failed to load users:", err);
    });
}

document.getElementById("loginAsSearchInput").addEventListener("input", () => loadUsers(true));
document.getElementById("loadMoreBtn").addEventListener("click", () => loadUsers(false));

// Initial load
loadUsers(true);
</script>
{% endblock %}