{# templates/bps/session_detail.html #}
{% extends "bps/base.html" %}
{% load crispy_forms_tags %} 

{% block content %}
  <h1>{{ sess.org_unit.name }} — {{ sess.scenario.name }}</h1>
  <p>
    <strong>Step:</strong> {{ stage.name }}  
    <small class="text-muted">using layout {{ layout.code }}</small>
  </p>

  {% if can_edit %}
    <form method="post">{% csrf_token %}
      {{ form|crispy }}
      <button name="start" class="btn btn-primary">Start Session</button>
    </form>
  {% endif %}

  <h2>Period Definition</h2>
  <form method="post">{% csrf_token %}
    {{ period_form|crispy }}
    <button name="apply" class="btn btn-secondary">Apply</button>
  </form>

  <h2>Raw Facts</h2>
  <table class="table table-striped">
    <thead>
      <tr>
        <th>Period</th><th>Key Figure</th><th>Value</th><th>UoM</th>
      </tr>
    </thead>
    <tbody>
      {% for fact in sess.current_facts %}
      <tr>
        <td>{{ fact.period.code }}</td>
        <td>{{ fact.key_figure.code }}</td>
        <td>{{ fact.value }}</td>
        <td>{{ fact.uom.code }}</td>
      </tr>
      {% empty %}
      <tr><td colspan="4">No facts yet.</td></tr>
      {% endfor %}
    </tbody>
  </table>

<form method="post" action="{% url 'bps:advance_step' sess.pk %}">
  {% csrf_token %}
  <button class="btn btn-sm btn-primary"
          {% if not user.is_staff %}disabled{% endif %}>
    Next Step →
  </button>
</form>
{% endblock %}