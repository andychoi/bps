{# templates/bps/session_detail.html #}
{% extends "bps/base.html" %}
{% load crispy_forms_tags %}

{% block extra_head %}
  {# needed only for your Period table below #}
  <script src="https://unpkg.com/vue@3"></script>
{% endblock %}

{% block content %}
  <h1>Planning: {{ sess.org_unit.name }} / {{ sess.layout_year }}</h1>

  {# — Start Session — #}
  {% if can_edit %}
    <form method="post" class="mb-3">{% csrf_token %}
      {{ form|crispy }}
    </form>
  {% endif %}

  {# — Period Definition — #}
  <h2>Period Definition</h2>
  <form method="post" class="mb-3">{% csrf_token %}
    {{ period_form|crispy }}
  </form>
  <div id="period-table">
    <vue-period-table :buckets="{{ periods|safe }}" />
  </div>

    <h2>Raw Facts ({{ dr.description }})</h2>
  <table class="table table-striped table-bordered">
    <thead>
      <tr>
        <th>Version</th>
        <th>Period</th>
        <th>Org Unit</th>
        <th>Service</th>
        <th>Key Figure</th>
        <th>Value</th>
        <th>Ref. Value</th>
      </tr>
    </thead>
    <tbody>
      {% for f in facts %}
      <tr>
        <td>{{ f.version.code }}</td>
        <td>{{ f.period.name }}</td>
        <td>{{ f.org_unit.name }}</td>
        <td>{% if f.service %}{{ f.service.name }}{% else %}&mdash;{% endif %}</td>
        <td>{{ f.key_figure.code }}</td>
        <td>{{ f.value }}</td>
        <td>{{ f.ref_value }}</td>
      </tr>
      {% empty %}
      <tr><td colspan="7" class="text-center">No facts found for this session.</td></tr>
      {% endfor %}
    </tbody>
  </table>
  
  {# — The Tabulator grid — #}
  <h2>Current Facts ({{ dr.description }})</h2>
  {% include "bps/_tabulator.html" with api_url=api_url detail_url=detail_url change_url=change_url create_url=create_url export_url=export_url owner_update_url=owner_update_url orgunit_update_url=orgunit_update_url user_ac_url=user_ac_url orgunit_ac_url=orgunit_ac_url %}
  
  {# — Session actions — #}
  {% if sess.status == sess.Status.DRAFT and request.user == sess.org_unit.head_user %}
    <form method="post" class="mt-3">{% csrf_token %}
      <button name="complete" class="btn btn-success">Mark Completed</button>
    </form>
  {% endif %}
  {% if sess.status == sess.Status.COMPLETED and request.user.is_staff %}
    <form method="post" class="mt-2">{% csrf_token %}
      <button name="freeze" class="btn btn-danger">Freeze Session</button>
    </form>
  {% endif %}
  {% if can_advance %}
    <form
      action="{% url 'bps:advance_stage' session_id=sess.pk %}"
      method="post"
      class="d-inline mt-2"
    >{% csrf_token %}
      <button class="btn btn-sm btn-primary">Next Step ➡️</button>
    </form>
  {% endif %}
{% endblock %}

{% block extra_js %}
  <script>
    // your Vue component for the period table
    const app = Vue.createApp({});
    app.component('vue-period-table', {
      props: ['buckets'],
      template: `
        <table class="table table-bordered mb-4">
          <thead>
            <tr><th v-for="b in buckets">{{ b.name }}</th></tr>
          </thead>
        </table>`
    });
    app.mount('#period-table');
  </script>
{% endblock %}