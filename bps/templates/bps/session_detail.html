{# templates/bps/session_detail.html #}
{% extends "bps/base.html" %}
{% load crispy_forms_tags %}
{% block content %}
  {# -- Breadcrumbs -- #}
  {% if breadcrumbs %}
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        {% for crumb in breadcrumbs %}
          <li class="breadcrumb-item {% if forloop.last %}active{% endif %}"
              {% if forloop.last %}aria-current="page"{% endif %}>
            {% if not forloop.last %}
              <a href="{{ crumb.url }}">{{ crumb.title }}</a>
            {% else %}
              {{ crumb.title }}
            {% endif %}
          </li>
        {% endfor %}
      </ol>
    </nav>
  {% endif %}

  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>{{ sess.org_unit.name }} ‚Äî {{ sess.scenario.name }}</h1>
    <a
      href="{% url 'bps:manual_planning' sess.layout_year.layout.id sess.layout_year.year.id sess.layout_year.version.id %}"
      class="btn btn-outline-primary"
    >
      üìù Open Manual Planning Grid
    </a>
  </div>

<div class="d-flex align-items-end gap-2 flex-wrap mb-4">
  {# -- if it hasn‚Äôt been started yet basically an assignment + start timestamp (implicit via created_at), not a status transition.-- #}
  <form method="post" class="d-flex align-items-end gap-2 flex-wrap">
    {% csrf_token %}
    {% if can_edit %}
      {{ form|crispy }}
      <button type="submit" name="start" class="btn btn-success">
        Assign to me & begin
      </button>
    {% endif %}

    <button
      type="submit"
      formaction="{% url 'bps:advance_step' sess.pk %}"
      class="btn btn-primary"
      {% if not can_advance %}disabled{% endif %}
    >
      Advance to next workflow step ‚Üí
    </button>
  </form>
</div>


<div class="card mt-4">
  <div class="card-header">Raw Facts</div>
  <div class="card-body">
    <div id="raw-facts-table"></div>
  </div>
</div>

<div id="raw-facts-table"></div>
<link href="https://cdn.jsdelivr.net/npm/tabulator-tables@6.3.1/dist/css/tabulator.min.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/tabulator-tables@6.3.1/dist/js/tabulator.min.js"></script>
<script>
(function(){
  const factsURL = "{% url 'bps_api:session-facts' sess.pk %}";

  new Tabulator("#raw-facts-table", {
    layout: "fitDataStretch",
    ajaxURL: factsURL,
    ajaxConfig: { credentials: "include" },

    // ‚úÖ Tabulator 6.3 pagination config
    pagination: true,
    paginationMode: "remote",
    paginationSize: 10,
    paginationSizeSelector: [10, 25, 50, 100],
    paginationCounter: "rows",

    // (optional) map param names if you need different ones:
    // dataSendParams: { page: "page", size: "size" },

    // (optional) map receive names if you rename "last_page" / "data"
    // dataReceiveParams: { last_page: "last_page", data: "data" },

    columns: [
      { title:"#", formatter:"rownum", width:60 },
      { title:"Org Unit", field:"org_unit" },
      { title:"Service",  field:"service" },
      { title:"Account",  field:"account" },
      { title:"Period",   field:"period", width:90 },
      { title:"Key Figure", field:"key_figure", width:140 },
      { title:"Value",    field:"value", hozAlign:"right" },
      { title:"UoM",      field:"uom", width:90 },
      { title:"Ref Value", field:"ref_value", hozAlign:"right" },
      { title:"Ref UoM",   field:"ref_uom", width:100 },
      { title:"Extra Dims", field:"extra_dimensions", formatter:function(cell){
          const v = cell.getValue() || {};
          try { return Object.keys(v).length ? JSON.stringify(v) : ""; } catch(e){ return ""; }
        }
      },
    ],
  });
})();
</script>

{% endblock %}