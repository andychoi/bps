{# templates/bps/session_detail.html #}
{% extends "bps/base.html" %}
{% load crispy_forms_tags %}

{% block extra_head %}
  <!-- Handsontable CSS/JS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@11/dist/handsontable.min.css">
  <script src="https://cdn.jsdelivr.net/npm/handsontable@11/dist/handsontable.min.js"></script>
{% endblock %}

{% block content %}
  <h1>Planning: {{ sess.org_unit }} / {{ sess.layout_year }}</h1>

  {% if can_edit %}
    <form method="post" class="mb-3">{% csrf_token %}
      {{ form|crispy }}
    </form>
  {% endif %}

  <h2>Period Definition</h2>
  <form method="post" class="mb-3">{% csrf_token %}
    {{ period_form|crispy }}
  </form>

  <div id="period-table">
    <vue-period-table :buckets="{{ periods|safe }}" />
  </div>

  <h2>Current Facts ({{ dr.description }})</h2>
  <div id="hot-table" style="width:100%;"></div>

  {% if sess.status == sess.Status.DRAFT and request.user == sess.org_unit.head_user %}
    <form method="post">
      {% csrf_token %}
      <button name="complete" class="btn btn-success">Mark Completed</button>
    </form>
  {% endif %}
  {% if sess.status == sess.Status.COMPLETED and request.user.is_staff %}
    <form method="post">
      {% csrf_token %}
      <button name="freeze" class="btn btn-danger">Freeze Session</button>
    </form>
  {% endif %}
  {% if sess.current_step and sess.can_advance(request.user) %}
    <form action="{% url 'bps:advance_stage' session_id=sess.pk %}" method="post" class="d-inline">
      {% csrf_token %}
      <button class="btn btn-sm btn-primary">Next Step ➡️</button>
    </form>
  {% endif %}  
{% endblock %}

{% block extra_js %}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const container = document.getElementById('hot-table');
      new Handsontable(container, {
        data: {{ hot_data }},
        colHeaders: ['Period','Key Figure','Value'],
        rowHeaders: true,
        licenseKey: 'non-commercial-and-evaluation',
        columns: [
          { data: 0, type: 'text',   readOnly: true },
          { data: 1, type: 'text',   readOnly: true },
          { data: 2, type: 'numeric', format: '0.00' }
        ],
        stretchH: 'all',
        manualColumnResize: true,
        manualRowResize: true
      });
    });
  </script>

  <script src="https://unpkg.com/vue@3"></script>
  <script>
    const app = Vue.createApp({});
    app.component('vue-period-table', {
      props: ['buckets'],
      template: `
        <table class="table table-bordered">
          <thead><tr><th v-for="b in buckets">{{ b.name }}</th></tr></thead>
        </table>`
    });
    app.mount('#period-table');
  </script>
{% endblock %}