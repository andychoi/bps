{% extends "bps/base.html" %}
{% load crispy_forms_tags %}
{% block content %}
<div class="container my-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="mb-0">Planning Functions</h1>
    <a href="{% url 'bps:dashboard' %}" class="btn btn-outline-secondary">← Back to Dashboard</a>
  </div>

  <!-- Create / Edit -->
  <div class="card mb-4">
    <div class="card-header">Add / Edit Function</div>
    <div class="card-body">
      <form method="post" class="mb-0">{% csrf_token %}
        {{ form|crispy }}
      </form>
    </div>
  </div>

  <!-- List -->
  <div class="card">
    <div class="card-header">Defined Functions</div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-striped table-hover mb-0 align-middle">
          <thead class="table-light">
            <tr>
              <th style="width: 22%">Name</th>
              <th style="width: 15%">Layout</th>
              <th style="width: 15%">Type</th>
              <th>Parameters (JSON)</th>
              <th style="width: 130px" class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for fn in functions %}
              <tr>
                <td class="fw-semibold">{{ fn.name }}</td>
                <td><code>{{ fn.layout.code }}</code></td>
                <td>{{ fn.get_function_type_display }}</td>
                <td><code class="small">{{ fn.parameters|default:"{}" }}</code></td>
                <td class="text-end">
                  <button
                    type="button"
                    class="btn btn-sm btn-primary"
                    data-bs-toggle="modal"
                    data-bs-target="#runModal"
                    data-fn-id="{{ fn.id }}"
                    data-fn-name="{{ fn.name }}"
                  >
                    Run…
                  </button>
                </td>
              </tr>
            {% empty %}
              <tr><td colspan="5" class="text-muted text-center py-4">No planning functions defined.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Run Modal -->
<div class="modal fade" id="runModal" tabindex="-1" aria-labelledby="runModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="runModalLabel">Run Function</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2">
          <div class="form-text">Function</div>
          <div id="run-fn-name" class="fw-semibold"></div>
        </div>
        <label for="run-session-id" class="form-label">Session ID</label>
        <input type="number" min="1" class="form-control" id="run-session-id" placeholder="Enter PlanningSession ID">
        <div class="form-text">
          Tip: open <a href="{% url 'bps:session_list' %}" target="_blank">Sessions</a> in a new tab to copy the ID.
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="run-confirm-btn">Run</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
(function(){
  // URL template like /functions/run/0/0/, replace with real ids at runtime
  const RUN_URL_TEMPLATE = "{% url 'bps:run_function' 0 0 %}";
  const runModalEl = document.getElementById('runModal');
  const fnNameEl   = document.getElementById('run-fn-name');
  const sessInput  = document.getElementById('run-session-id');
  const confirmBtn = document.getElementById('run-confirm-btn');

  let currentFnId = null;

  runModalEl.addEventListener('show.bs.modal', event => {
    const btn = event.relatedTarget;
    currentFnId = btn.getAttribute('data-fn-id');
    const fnName = btn.getAttribute('data-fn-name') || '';
    fnNameEl.textContent = fnName;
    sessInput.value = '';
    setTimeout(()=>sessInput.focus(), 200);
  });

  confirmBtn.addEventListener('click', () => {
    const sessId = (sessInput.value || '').trim();
    if (!sessId) { sessInput.focus(); return; }
    // Build /functions/run/<fn>/<session>/
    const url = RUN_URL_TEMPLATE.replace('/0/0/', `/${currentFnId}/${sessId}/`);
    window.location.href = url;
  });
})();
</script>
{% endblock %}